<!doctype html>
<html>
  <head>
    <title>MySpotifySound</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style type="text/css">
      #login, #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
      .artist-image {
        margin-left:2em;
        display:inline-block;
        width:100px;
        height:100px;
        object-fit:cover;
      }
    </style>
  </head>
  <body>
    <%- include('partials/navbar') %>

    <center>
    <br>
      <h2>Your Top Genres</h2>
    </center>

    <div id="top-genres">
    </div>

    <script id="top-genres-template" type="text/x-handlebars-template">
      <br>
      <div class="d-flex justify-content-between container" style="border:1px solid #cecece;background-color:#E8E8E8;padding-top:1em;padding-bottom:1em;">
        <div>
          <h2 style="margin-left:1em;display:inline-block;">{{rank}}.&nbsp;{{genre}}</h2>
          <p style="margin-left:2em">{{count}} of your top 50 artists are {{genre}}.</p>
        </div>
        <div style="display:inline-block;" class="float-right">
          <p style="margin-left:2em"> Your top {{genre}} artists: </p>
          <img class="media artist-image" src="{{image1}}"/>
          <img class="media artist-image" src="{{image2}}"/>
          <img class="media artist-image" src="{{image3}}"/>
        </div>
      </div>
      <br>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      (function() {
        var topGenresSource = document.getElementById('top-genres-template').innerHTML,
            topGenresTemplate = Handlebars.compile(topGenresSource),
            topGenresPlaceholder = document.getElementById('top-genres');
        $.ajax({
            url: 'https://api.spotify.com/v1/me/top/artists?time_range=long_term&limit=50',
            headers: {
              'Authorization': 'Bearer ' + "<%- token %>"
            },
            success: function(response) {
              var genreCount = {};
              var html = "";
              for (var i = 0; i < response.items.length; i++) {
                for (var j = 0; j < response.items[i].genres.length; j++) {
                  if (genreCount[response.items[i].genres[j]]) {
                    genreCount[response.items[i].genres[j]][0] += 1;
                  } else {
                    genreCount[response.items[i].genres[j]] = [1];
                  }
                  if (genreCount[response.items[i].genres[j]].length < 4) {
                    genreCount[response.items[i].genres[j]].push(response.items[i].images[0].url)
                  }
                }
              }
              var sortedGenres = Object.entries(genreCount).sort(function(a, b) {
                return b[1][0] - a[1][0];
              }).slice(0, 10);
              // var sortedGenres = Object.entries(genreCount).sort(function(a, b) {
              //   return b[1] - a[1];
              // }).slice(0, 10);
              for (i = 0; i < sortedGenres.length; i++) {
                console.log({ genre: sortedGenres[i][0],
                              count: sortedGenres[i][1][0],
                              image1: sortedGenres[i][1][1],
                              image2: sortedGenres[i][1][2],
                              image3: sortedGenres[i][1][3],
                              rank: i + 1 });
                html += topGenresTemplate({ genre: sortedGenres[i][0],
                                            count: sortedGenres[i][1][0],
                                            image1: sortedGenres[i][1][1],
                                            image2: sortedGenres[i][1][2],
                                            image3: sortedGenres[i][1][3],
                                            rank: i + 1 });
              }
              topGenresPlaceholder.innerHTML = html;
            }
        });
      })();
    </script>
  </body>
</html>
